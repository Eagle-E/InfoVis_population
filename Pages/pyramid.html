<html>
<head>
    <script src="https://d3js.org/d3.v3.min.js"></script>
    <script src="../Scripts/jquery.csv.js"></script>

    <link rel="stylesheet" href="../Stylesheets/nav.css">

    <style>
        svg {
            border: 1px solid #ccc;
        }
        .axis line,
        .axis path {
            shape-rendering: crispEdges;
            fill: transparent;
            stroke: #555;
        }
        .axis text {
            font-size: 11px;
        }
        .bar {
            fill-opacity: 0.5;
        }
        .bar.left {
            fill: rgb(246, 51, 213);
        }
        .bar.right {
            fill: rgb(0, 0, 255);
        }
    </style>

    <script language="javascript">
      function countryChange(value){
        changeData();
      }
      function translation(x,y) {
        return 'translate(' + x + ',' + y + ')';
      }
      function init(){
        var c = "WORLD";
        var y = "2020";
        var loc = "../data/popCountries/"+c+"_"+y+".csv";

        var select = document.getElementById("debug");
        select.innerHTML = "This chart is from the following data: \n"+c + "_" + y+".csv";

        d3.csv(loc, function(data) {
          draw_pyramide(data);
        });
      }
      
      function draw_pyramide(exampleData){
        // SET UP DIMENSIONS
        var w = 500,
            h = 300;
      
        // margin.middle is distance from center line to each y-axis
        var margin = {
          top: 20,
          right: 20,
          bottom: 24,
          left: 20,
          middle: 28
        };
      
        // the width of each side of the chart
        var regionWidth = w/2 - margin.middle;
      
        // these are the x-coordinates of the y-axes
        var pointA = regionWidth,
            pointB = w - regionWidth;

        // GET THE TOTAL POPULATION SIZE AND CREATE A FUNCTION FOR RETURNING THE PERCENTAGE
        var totalPopulation = d3.sum(exampleData, function(d) { return d.M + d.F; });
        var totalM = d3.sum(exampleData, function(d) { return d.M });
        var totalF = d3.sum(exampleData, function(d) { return d.F });
    
        percentage = function(d) { return d / totalPopulation; };
        percentageM = function(d) { return d / totalM; };
        percentageF = function(d) { return d / totalF; };
    
        // CREATE SVG
        d3.select("svg").remove();
        
        var svg = d3.select('#pyramide').append('svg')
          .attr('width', margin.left + w + margin.right)
          .attr('height', margin.top + h + margin.bottom)
          // ADD A GROUP FOR THE SPACE WITHIN THE MARGINS
          .append('g')
            .attr('transform', translation(margin.left, margin.top));
    
        // find the maximum data value on either side
        //  since this will be shared by both of the x-axes
        var maxValue = Math.max(
          d3.max(exampleData, function(d) { return percentageM(d.M); }),
          d3.max(exampleData, function(d) { return percentageF(d.F); })
        );
    
        // console.log("Total pop: "+ totalPopulation)
        // console.log(maxValue);
    
        // SET UP SCALES
        // the xScale goes from 0 to the width of a region
        //  it will be reversed for the left x-axis
        var xScale = d3.scale.linear()
          .domain([0, maxValue])
          .range([0, regionWidth])
          .nice();
    
        var xScaleLeft = d3.scale.linear()
          .domain([0, maxValue])
          .range([regionWidth, 0]);
    
        var xScaleRight = d3.scale.linear()
          .domain([0, maxValue])
          .range([0, regionWidth]);
    
        var yScale = d3.scale.ordinal()
          .domain(exampleData.map(function(d) { return d.Age; }))
          .rangeRoundBands([h,0], 0.1);
        // SET UP AXES
    
        var yAxisLeft = d3.svg.axis()
          .scale(yScale)
          .orient('right')
          .tickSize(4,0)
          .tickPadding(margin.middle-4);
    
        var yAxisRight = d3.svg.axis()
          .scale(yScale)
          .orient('left')
          .tickSize(4,0)
          .tickFormat('');
    
        var xAxisRight = d3.svg.axis()
          .scale(xScale)
          .orient('bottom')
          .tickFormat(d3.format('%'));
    
        var xAxisLeft = d3.svg.axis()
          // REVERSE THE X-AXIS SCALE ON THE LEFT SIDE BY REVERSING THE RANGE
          .scale(xScale.copy().range([pointA, 0]))
          .orient('bottom')
          .tickFormat(d3.format('%'));
    
          // MAKE GROUPS FOR EACH SIDE OF CHART
        // scale(-1,1) is used to reverse the left side so the bars grow left instead of right
        var leftBarGroup = svg.append('g')
          .attr('transform', translation(pointA, 0) + 'scale(-1,1)');
        var rightBarGroup = svg.append('g')
          .attr('transform', translation(pointB, 0));
    
        // DRAW AXES
        svg.append('g')
          .attr('class', 'axis y left')
          .attr('transform', translation(pointA, 0))
          .call(yAxisLeft)
          .selectAll('text')
          .style('text-anchor', 'middle');
        svg.append('g')
          .attr('class', 'axis y right')
          .attr('transform', translation(pointB, 0))
          .call(yAxisRight);
        svg.append('g')
          .attr('class', 'axis x left')
          .attr('transform', translation(0, h))
          .call(xAxisLeft);
        svg.append('g')
          .attr('class', 'axis x right')
          .attr('transform', translation(pointB, h))
          .call(xAxisRight);
    
          // DRAW BARS
        leftBarGroup.selectAll('.bar.left')
          .data(exampleData)
          .enter().append('rect')
            .attr('class', 'bar left')
            .attr('x', 0)
            .attr('y', function(d) { return yScale(d.Age); })
            .attr('width', function(d) { return xScale(percentageM(d.M)); })
            .attr('height', yScale.rangeBand());
        rightBarGroup.selectAll('.bar.right')
          .data(exampleData)
          .enter().append('rect')
            .attr('class', 'bar right')
            .attr('x', 0)
            .attr('y', function(d) { return yScale(d.Age); })
            .attr('width', function(d) { return xScale(percentageF(d.F)); })
            .attr('height', yScale.rangeBand());
      }

      function changeData(){
        var e = document.getElementById("sLand");
        var v = e.value;
        
        var e2 = document.getElementById("sYear");
        var v2 = e2.value;

        //console.log(v1 + " :: " + v2);
        var select = document.getElementById("debug");
        select.innerHTML = v + " :: " + v2;

        var c = v;
        var y = v2;
        var loc = "../data/popCountries/"+c+"_"+y+".csv";
        d3.csv(loc, function(data) {
          draw_pyramide(data);
        });
      }
    </script>
</head>

<body onload="init()"> 
  <div class="topnav">
    <a href="#p1">S-Page</a>
    <a class="active" href="#p2">Population Pyramide</a>
    <a href="#p3">R-page</a>
  </div>

  <div>
    <h1> Population pyramide</h1>
    <p id="debug"> Design is under construction...</p>
  </div>

  <div id="selectorz">
    <form id="myForm">
      <select id="sLand" onchange="countryChange(this.value);">
        <option>Choose Country</option>
      </select>

      <select id="sYear" onchange="countryChange(this.value);">
        <option>Choose Year</option>
      </select>
    </form>

    <script lang="javascript">
      var select = document.getElementById("sYear");
      var options = ["1950", "1955", "1960", "1965", "1970", "1975", "1980", "1985", "1990", "1995", "2000", "2005", "2010", "2015", "2020"];
      
      for(var i = 0; i < options.length; i++) {
        var opt = options[i];
        var el = document.createElement("option");
        el.textContent = opt;
        el.value = opt;
        select.appendChild(el);
      }
    </script>

    <script lang="javascript">
      var select = document.getElementById("sLand");
      var options = 
      ["WORLD","UN development groups", "More developed regions",
      "Less developed regions", "Least developed countries",
      "Less developed regions, excluding least developed countries",
      "Less developed regions, excluding China",
      "Land-locked Developing Countries (LLDC)",
      "Small Island Developing States (SIDS)", "World Bank income groups",
      "High-income countries",,"Middle-income countries",
      "Upper-middle-income countries", "Lower-middle-income countries",
      "Low-income countries","No income group available","Geographic regions",
      "Africa","Asia","Europe","Latin America and the Caribbean",
      "Northern America","Oceania","Sustainable Development Goal (SDG) regions",
      "SUB-SAHARAN AFRICA","Eastern Africa","Burundi","Comoros","Djibouti",
      "Eritrea","Ethiopia","Kenya","Madagascar","Malawi","Mauritius","Mayotte",
      "Mozambique","Réunion","Rwanda","Seychelles","Somalia","South Sudan",
      "Uganda","United Republic of Tanzania","Zambia","Zimbabwe",
      "Middle Africa","Angola","Cameroon","Central African Republic","Chad",
      "Congo","Democratic Republic of the Congo","Equatorial Guinea","Gabon",
      "Sao Tome and Principe","Southern Africa","Botswana","Eswatini","Lesotho",
      "Namibia","South Africa","Western Africa","Benin","Burkina Faso",
      "Cabo Verde","Côte d'Ivoire","Gambia","Ghana","Guinea","Guinea-Bissau",
      "Liberia","Mali","Mauritania","Niger","Nigeria","Senegal","Sierra Leone",
      "Togo","NORTHERN AFRICA AND WESTERN ASIA","Northern Africa","Algeria",
      "Egypt","Libya","Morocco","Sudan","Tunisia","Western Sahara",
      "Western Asia","Armenia","Azerbaijan","Bahrain","Cyprus","Georgia","Iraq",
      "Israel","Jordan","Kuwait","Lebanon","Oman","Qatar","Saudi Arabia",
      "State of Palestine","Syrian Arab Republic","Turkey",
      "United Arab Emirates","Yemen","CENTRAL AND SOUTHERN ASIA","Central Asia",
      "Kazakhstan","Kyrgyzstan","Tajikistan","Turkmenistan","Uzbekistan",
      "Southern Asia","Afghanistan","Bangladesh","Bhutan","India",
      "Iran (Islamic Republic of)","Maldives","Nepal","Pakistan","Sri Lanka",
      "EASTERN AND SOUTH-EASTERN ASIA","Eastern Asia","China",
      "China, Hong Kong SAR","China, Macao SAR",
      "China, Taiwan Province of China","Dem. People's Republic of Korea",
      "Japan","Mongolia","Republic of Korea","South-Eastern Asia",
      "Brunei Darussalam","Cambodia","Indonesia",
      "Lao People's Democratic Republic","Malaysia","Myanmar","Philippines",
      "Singapore","Thailand","Timor-Leste","Viet Nam",
      "LATIN AMERICA AND THE CARIBBEAN","Caribbean","Antigua and Barbuda",
      "Aruba","Bahamas","Barbados","Cuba","Curaçao","Dominican Republic",
      "Grenada","Guadeloupe","Haiti","Jamaica","Martinique","Puerto Rico",
      "Saint Lucia","Saint Vincent and the Grenadines","Trinidad and Tobago",
      "United States Virgin Islands","Central America","Belize","Costa Rica",
      "El Salvador","Guatemala","Honduras","Mexico","Nicaragua","Panama",
      "South America","Argentina","Bolivia (Plurinational State of)","Brazil",
      "Chile","Colombia","Ecuador","French Guiana","Guyana","Paraguay","Peru",
      "Suriname","Uruguay","Venezuela (Bolivarian Republic of)",
      "AUSTRALIA/NEW ZEALAND","Australia","New Zealand",
      "OCEANIA (EXCLUDING AUSTRALIA AND NEW ZEALAND)","Melanesia","Fiji",
      "New Caledonia","Papua New Guinea","Solomon Islands","Vanuatu",
      "Micronesia","Guam","Kiribati","Micronesia (Fed. States of)","Polynesia",
      "French Polynesia","Samoa","Tonga","EUROPE AND NORTHERN AMERICA","EUROPE",
      "Eastern Europe","Belarus","Bulgaria","Czechia","Hungary","Poland",
      "Republic of Moldova","Romania","Russian Federation","Slovakia","Ukraine",
      "Northern Europe","Channel Islands","Denmark","Estonia","Finland",
      "Iceland","Ireland","Latvia","Lithuania","Norway","Sweden",
      "United Kingdom","Southern Europe","Albania","Bosnia and Herzegovina",
      "Croatia","Greece","Italy","Malta","Montenegro","North Macedonia",
      "Portugal","Serbia","Slovenia","Spain","Western Europe","Austria",
      "Belgium","France","Germany","Luxembourg","Netherlands","Switzerland",
      "NORTHERN AMERICA","Canada","United States of America"];
      
      for(var i = 0; i < options.length; i++) {
        var opt = options[i];
        var el = document.createElement("option");
        el.textContent = opt;
        el.value = opt;
        select.appendChild(el);
      }
    </script>
  </div>

  <div id="pyramide"></div>

</body>
</html>